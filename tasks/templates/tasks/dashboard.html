{% extends 'tasks/base.html' %}

{% block title %}Dashboard - chtodoist{% endblock %}

{% block content %}
<h1 style="margin-bottom: 1rem;">Task Dashboard</h1>

<div style="margin-bottom: 2rem;">
    <a href="?filter=all" class="btn {% if filter_type == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">All Tasks</a>
    <a href="?filter=today" class="btn {% if filter_type == 'today' %}btn-primary{% else %}btn-secondary{% endif %}">Today</a>
    <a href="?filter=week" class="btn {% if filter_type == 'week' %}btn-primary{% else %}btn-secondary{% endif %}">This Week</a>
    <a href="?filter=overdue" class="btn {% if filter_type == 'overdue' %}btn-danger{% else %}btn-secondary{% endif %}">Overdue</a>
</div>

<div class="card">
    <h2>Active Templates</h2>
    {% if templates %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
        {% for template in templates %}
        <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 4px;">
            <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">{{ template.name }}</h3>
            <p style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">{{ template.content_template }}</p>
            <span class="badge badge-primary">{{ template.get_frequency_display }}</span>
            {% if template.auto_complete %}
            <span class="badge badge-success">Auto-complete</span>
            {% endif %}
            <form method="post" action="{% url 'template_generate' template.id %}" style="margin-top: 0.5rem;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success" style="width: 100%;">Generate Task</button>
            </form>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: #666; margin-top: 1rem;">No active templates. <a href="{% url 'template_create' %}">Create one</a></p>
    {% endif %}
</div>

<div class="card" style="margin-top: 2rem;">
    <h2>Tasks ({{ tasks|length }})</h2>
    {% if tasks %}
    <table>
        <thead>
            <tr>
                <th>Task</th>
                <th>Project</th>
                <th>Due Date</th>
                <th>Priority</th>
                <th>Watchers</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>
                    <strong>{{ task.content }}</strong>
                    {% if task.description %}
                    <br><span style="font-size: 0.875rem; color: #666;">{{ task.description|truncatewords:20 }}</span>
                    {% endif %}
                    {% if task.auto_complete_rule %}
                    <br><span class="badge badge-success">Auto-complete enabled</span>
                    {% endif %}
                </td>
                <td>{{ task.project_name }}</td>
                <td>
                    {% if task.due %}
                        {{ task.due.date }}
                        {% if task.due.is_recurring %}
                        <span class="badge badge-primary">Recurring</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #999;">No due date</span>
                    {% endif %}
                </td>
                <td>
                    {% if task.priority == 4 %}
                    <span class="badge badge-danger">Urgent</span>
                    {% elif task.priority == 3 %}
                    <span class="badge badge-warning">High</span>
                    {% elif task.priority == 2 %}
                    <span class="badge badge-primary">Medium</span>
                    {% else %}
                    <span class="badge" style="background: #95a5a6; color: white;">Low</span>
                    {% endif %}
                </td>
                <td>
                    {% if task.watchers %}
                    <div style="font-size: 0.875rem;">
                        {% for watcher in task.watchers %}
                        {{ watcher.watcher.username }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <button onclick="showWatcherForm('{{ task.id }}', '{{ task.content|escapejs }}')" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Add Watcher</button>
                    {% endif %}
                </td>
                <td>
                    <form method="post" action="{% url 'task_complete' task.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Complete</button>
                    </form>
                    {% if not task.auto_complete_rule %}
                    <button onclick="showAutoCompleteForm('{{ task.id }}', '{{ task.content|escapejs }}')" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Auto-complete</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666; margin-top: 1rem;">No tasks found.</p>
    {% endif %}
</div>

<!-- Hidden forms for modals -->
<div id="watcher-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="card" style="max-width: 400px; margin: 100px auto;">
        <h2>Add Watcher</h2>
        <form method="post" action="{% url 'watcher_add' %}">
            {% csrf_token %}
            <input type="hidden" name="task_id" id="watcher-task-id">
            <input type="hidden" name="task_content" id="watcher-task-content">
            <label for="watcher_username">Username:</label>
            <input type="text" name="watcher_username" id="watcher_username" required>
            <button type="submit" class="btn btn-success">Add Watcher</button>
            <button type="button" onclick="hideWatcherForm()" class="btn btn-secondary">Cancel</button>
        </form>
    </div>
</div>

<div id="autocomplete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="card" style="max-width: 400px; margin: 100px auto;">
        <h2>Enable Auto-Complete</h2>
        <form method="post" action="{% url 'autocomplete_create' %}">
            {% csrf_token %}
            <input type="hidden" name="task_id" id="autocomplete-task-id">
            <input type="hidden" name="task_content" id="autocomplete-task-content">
            <label for="hours">Hours after due date to auto-complete:</label>
            <input type="number" name="hours" id="hours" value="0" min="0" required>
            <button type="submit" class="btn btn-success">Enable Auto-Complete</button>
            <button type="button" onclick="hideAutoCompleteForm()" class="btn btn-secondary">Cancel</button>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function showWatcherForm(taskId, taskContent) {
    document.getElementById('watcher-task-id').value = taskId;
    document.getElementById('watcher-task-content').value = taskContent;
    document.getElementById('watcher-modal').style.display = 'block';
}

function hideWatcherForm() {
    document.getElementById('watcher-modal').style.display = 'none';
}

function showAutoCompleteForm(taskId, taskContent) {
    document.getElementById('autocomplete-task-id').value = taskId;
    document.getElementById('autocomplete-task-content').value = taskContent;
    document.getElementById('autocomplete-modal').style.display = 'block';
}

function hideAutoCompleteForm() {
    document.getElementById('autocomplete-modal').style.display = 'none';
}
</script>
{% endblock %}
